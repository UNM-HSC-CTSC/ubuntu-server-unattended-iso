#!/bin/bash

# Build all profiles
# This script builds ISOs for all profiles in the profiles/ directory

set -euo pipefail

# Script directory - handle both old and new locations
if [ -L "${BASH_SOURCE[0]}" ]; then
    # If called via symlink, get the real script location
    REAL_SCRIPT="$(readlink -f "${BASH_SOURCE[0]}")"
    SCRIPT_DIR="$(cd "$(dirname "$REAL_SCRIPT")/.." && pwd)"
else
    # If called directly from bin/, go up one level
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
fi

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Counters
TOTAL=0
SUCCESS=0
FAILED=0

echo -e "${GREEN}Ubuntu Server Unattended ISO Builder - Build All Profiles${NC}"
echo "======================================================="
echo

# Check if build-iso.sh exists
if [ ! -f "${SCRIPT_DIR}/build-iso.sh" ]; then
    echo -e "${RED}Error:${NC} build-iso.sh not found"
    exit 1
fi

# Make sure it's executable
chmod +x "${SCRIPT_DIR}/build-iso.sh"

# Find all profiles
if [ ! -d "${SCRIPT_DIR}/profiles" ]; then
    echo -e "${RED}Error:${NC} profiles directory not found"
    exit 1
fi

# Build each profile
for profile_dir in "${SCRIPT_DIR}"/profiles/*/; do
    if [ -d "$profile_dir" ]; then
        profile_name=$(basename "$profile_dir")
        ((TOTAL++))
        
        echo -e "\n${YELLOW}Building profile:${NC} $profile_name"
        echo "----------------------------------------"
        
        if "${SCRIPT_DIR}/build-iso.sh" --profile "$profile_name"; then
            ((SUCCESS++))
            echo -e "${GREEN}✓${NC} Successfully built $profile_name"
        else
            ((FAILED++))
            echo -e "${RED}✗${NC} Failed to build $profile_name"
        fi
    fi
done

# Summary
echo
echo "======================================================="
echo -e "Build Summary:"
echo -e "  Total profiles: $TOTAL"
echo -e "  Successful:     ${GREEN}$SUCCESS${NC}"
echo -e "  Failed:         ${RED}$FAILED${NC}"
echo

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}All profiles built successfully!${NC}"
    exit 0
else
    echo -e "${RED}Some profiles failed to build${NC}"
    exit 1
fi